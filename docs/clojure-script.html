<!DOCTYPE html>  <html> <head>   <title>clojure-script.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="clojure-script.html">                 clojure-script.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="extensions.html">                 extensions.coffee               </a>                                           <a class="source" href="optparse.html">                 optparse.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="repl.html">                 repl.coffee               </a>                                           <a class="source" href="exporter.html">                 exporter.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               clojure-script.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="o">`</span> <span class="o">//</span> <span class="nx">TOP</span> <span class="o">`</span>

<span class="nv">fs   = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>

<span class="nv">ClojureScript = </span><span class="p">{}</span>

<span class="nv">ClojureScript.VERSION = </span><span class="s">&#39;0.0.0-7-pre&#39;</span>

<span class="nv">ClojureScript.Tempdir = </span><span class="nx">require</span> <span class="s">&#39;temporary/lib/dir&#39;</span>

<span class="nv">ClojureScript.defaultJavaOptions = </span><span class="s">&#39;&#39;</span>
<span class="nv">ClojureScript.javaOptions = </span><span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">defaultJavaOptions</span>

<span class="nv">ClojureScript.initJava = </span><span class="nf">(options) -&gt;</span>
  <span class="vi">@java = </span><span class="nv">java = </span><span class="nx">require</span> <span class="s">&#39;java&#39;</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/lib/clojure.jar&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/lib/compiler.jar&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/lib/goog.jar&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/lib/js.jar&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/src/clj&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clojure-clojurescript/src/cljs&#39;</span> <span class="p">)</span>
  <span class="nx">java</span><span class="p">.</span><span class="nx">classpath</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clj&#39;</span> <span class="p">)</span>

<span class="nv">ClojureScript.initClojureCompiler = </span><span class="nf">(javaOptions = ClojureScript.javaOptions) -&gt;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">@java</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">@initJava</span> <span class="nx">javaOptions</span>
  <span class="vi">@StringReader = </span><span class="nv">StringReader = </span><span class="nx">@java</span><span class="p">.</span><span class="nx">import</span> <span class="s">&#39;java.io.StringReader&#39;</span>
  <span class="vi">@ClojureCompiler = </span><span class="nv">ClojureCompiler = </span><span class="nx">@java</span><span class="p">.</span><span class="nx">import</span> <span class="s">&#39;clojure.lang.Compiler&#39;</span>

  <span class="nv">ncljsc = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/clj/ncljsc.clj&#39;</span> <span class="p">),</span> <span class="s">&#39;utf8&#39;</span>
  <span class="nv">ncljscSR = </span><span class="k">new</span> <span class="nx">StringReader</span> <span class="nx">ncljsc</span>
  <span class="nx">ClojureCompiler</span><span class="p">.</span><span class="nx">loadSync</span> <span class="nx">ncljscSR</span>

  <span class="vi">@clojureAddClassPath = </span><span class="nx">@java</span><span class="p">.</span><span class="nx">callStaticMethodSync</span> <span class="s">&#39;clojure.lang.RT&#39;</span><span class="p">,</span> <span class="s">&#39;var&#39;</span><span class="p">,</span> <span class="s">&#39;ncljsc&#39;</span><span class="p">,</span> <span class="s">&#39;pom-add-classpath&#39;</span>

  <span class="vi">@addClassPath = </span><span class="nf">(cp) -&gt;</span>
    <span class="nx">@clojureAddClassPath</span><span class="p">.</span><span class="nx">invokeSync</span> <span class="nx">cp</span>

  <span class="vi">@clojureBuild = </span><span class="nx">@java</span><span class="p">.</span><span class="nx">callStaticMethodSync</span> <span class="s">&#39;clojure.lang.RT&#39;</span><span class="p">,</span> <span class="s">&#39;var&#39;</span><span class="p">,</span> <span class="s">&#39;ncljsc&#39;</span><span class="p">,</span> <span class="s">&#39;build&#39;</span>

<span class="nv">ClojureScript.addClassPath = </span><span class="nf">(cp) -&gt;</span>
  <span class="nx">@initClojureCompiler</span><span class="p">()</span>
  <span class="nx">@addClassPath</span> <span class="nx">cp</span>

<span class="nv">ClojureScript.defaultOptions = </span><span class="s">&#39;{:optimizations :simple :target :nodejs :pretty-print false}&#39;</span>
<span class="nv">ClojureScript.options = </span><span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">defaultOptions</span>

<span class="nv">ClojureScript.tmp = </span><span class="k">new</span> <span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">Tempdir</span>

<span class="nv">pathCompiledCoreJS = </span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/out/cljs/core.js&#39;</span>
<span class="nv">compiledCoreJS = </span><span class="s">&#39;&#39;</span>
<span class="nv">ClojureScript.compiledCoreJS = </span><span class="o">-&gt;</span> <span class="nx">compiledCoreJS</span>
<span class="k">if</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">pathCompiledCoreJS</span> <span class="p">)</span>
  <span class="nv">compiledCoreJS = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">pathCompiledCoreJS</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span>
  <span class="nv">ClojureScript.compiledCoreJS = </span><span class="o">-&gt;</span> <span class="nx">compiledCoreJS</span>
  <span class="nv">ClojureScript.compiledCoreJS.exists = </span><span class="kc">true</span>

<span class="nv">pathCompiledNodejsJS = </span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/support/out/cljs/nodejs.js&#39;</span>
<span class="nv">compiledNodejsJS = </span><span class="s">&#39;&#39;</span>
<span class="nv">ClojureScript.compiledNodejsJS = </span><span class="o">-&gt;</span> <span class="nx">compiledNodejsJS</span>
<span class="k">if</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">pathCompiledNodejsJS</span> <span class="p">)</span>
  <span class="nv">compiledNodejsJS = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">pathCompiledNodejsJS</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span>
  <span class="nv">ClojureScript.compiledNodejsJS = </span><span class="o">-&gt;</span> <span class="nx">compiledNodejsJS</span>
  <span class="nv">ClojureScript.compiledNodejsJS.exists = </span><span class="kc">true</span>

<span class="nv">ClojureScript.tmpOut = </span><span class="nf">(options) -&gt;</span> <span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">...(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)]</span> <span class="o">+</span> <span class="s">&quot; :tmp-out \&quot;</span><span class="si">#{</span> <span class="nx">@tmp</span><span class="p">.</span><span class="nx">path</span> <span class="si">}</span><span class="s">\&quot;}&quot;</span>
<span class="nv">ClojureScript.addBuildClasspath = </span><span class="nf">(options, cp) -&gt;</span> <span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">...(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)]</span> <span class="o">+</span> <span class="s">&quot; :add-classpath \&quot;</span><span class="si">#{</span> <span class="nx">cp</span> <span class="si">}</span><span class="s">\&quot;}&quot;</span>

<span class="nv">ClojureScript.build = </span><span class="nf">(target, options = ClojureScript.options, javaOptions = ClojureScript.javaOptions) -&gt;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">@java</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">@initJava</span> <span class="nx">javaOptions</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">@ClojureCompiler</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">@initClojureCompiler</span><span class="p">()</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">isnt</span> <span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">options</span> <span class="p">)</span>
    <span class="nv">options = </span><span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^\s*(\{.*\})\s*$/</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">options</span> <span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;malformed options string&#39;</span>
    <span class="k">else</span>
      <span class="nv">options = </span><span class="nx">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*\&#39;.*\&#39;/</span> <span class="p">)</span> <span class="o">or</span> <span class="o">\</span>
         <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*[^\&#39;\&quot;]*(\:|(\}$))/</span> <span class="p">)</span> <span class="o">or</span> <span class="o">\</span>
         <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*\&#39;[^\&#39;]*(\:|(\}$))/</span> <span class="p">)</span> <span class="o">or</span> <span class="o">\</span>
         <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*\&quot;[^\&quot;]*(\:|(\}$))/</span> <span class="p">)</span> <span class="o">or</span> <span class="o">\</span>
         <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*[^\&#39;]*\&#39;\s*(\:|(\}$))/</span> <span class="p">)</span> <span class="o">or</span> <span class="o">\</span>
         <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*[^\&quot;]*\&quot;\s*(\:|(\}$))/</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;path specified as :output-dir must be wrapped in double-quotes&#39;</span>

    <span class="nv">outputdir = </span><span class="nx">options</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\:output-dir\s*(\&quot;.*\&quot;)/</span>
    <span class="k">if</span> <span class="nx">outputdir</span>
      <span class="nv">outputdir = </span><span class="nx">outputdir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">outputdir = </span><span class="nx">outputdir</span><span class="p">[</span><span class="mi">1</span><span class="p">...(</span> <span class="nx">outputdir</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)]</span>
      <span class="nv">outputdir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span> <span class="nx">outputdir</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">outputdir</span> <span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;path specified as :output-dir must exist&#39;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="p">(</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">outputdir</span> <span class="p">).</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;path specified as :output-dir must be a directory&#39;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="nx">outputdir</span><span class="o">?</span> <span class="p">)</span>
    <span class="nv">outputdir = </span><span class="nx">@tmp</span><span class="p">.</span><span class="nx">path</span>
    <span class="nv">options = </span><span class="nx">@tmpOut</span> <span class="nx">options</span>

  <span class="nv">outcljs = </span><span class="nx">outputdir</span> <span class="o">+</span> <span class="s">&#39;/cljs&#39;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">outcljs</span> <span class="p">)</span> <span class="p">)</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">outcljs</span>

  <span class="k">if</span> <span class="nx">@compiledCoreJS</span><span class="p">.</span><span class="nx">exists</span>
    <span class="nv">outcljscore = </span><span class="nx">outcljs</span> <span class="o">+</span> <span class="s">&#39;/core.js&#39;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">outcljscore</span> <span class="p">)</span> <span class="p">)</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="nx">outcljscore</span><span class="p">,</span> <span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">compiledCoreJS</span><span class="p">(),</span> <span class="s">&#39;utf8&#39;</span>

  <span class="k">if</span> <span class="nx">@compiledNodejsJS</span><span class="p">.</span><span class="nx">exists</span>
    <span class="nv">outcljsnodejs = </span><span class="nx">outcljs</span> <span class="o">+</span> <span class="s">&#39;/nodejs.js&#39;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">outcljsnodejs</span> <span class="p">)</span> <span class="p">)</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="nx">outcljsnodejs</span><span class="p">,</span> <span class="nx">ClojureScript</span><span class="p">.</span><span class="nx">compiledNodejsJS</span><span class="p">(),</span> <span class="s">&#39;utf8&#39;</span>

  <span class="nv">resolved = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span> <span class="nx">target</span> <span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">not</span> <span class="p">(</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">resolved</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;target path must exist&#39;</span>
  <span class="nv">stats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">resolved</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="p">)</span>
    <span class="nv">cp = </span><span class="nx">resolved</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()</span> <span class="p">)</span>
    <span class="nv">cp = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">resolved</span>
  <span class="k">else</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;target path must be a file or a directory&#39;</span>

  <span class="nv">options = </span><span class="nx">@addBuildClasspath</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cp</span>

  <span class="nx">@clojureBuild</span><span class="p">.</span><span class="nx">invokeSync</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&lt;&lt;&lt;>>></p>

<h3>node-clojurescript</h3>

<p><a href="http://michaelsbradleyjr.github.com/node-clojurescript">http://michaelsbradleyjr.github.com/node-clojurescript</a></p>

<p>This software is Copyright (c) 2012 by Michael Bradley, Jr.</p>

<p>The use and distribution terms for this software are covered by the
<a href="http://opensource.org/licenses/eclipse-1.0.php">Eclipse Public License 1.0</a> which can be found in the file
<a href="http://michaelsbradleyjr.github.com/node-clojurescript/licenses/epl-v10.html">epl-v10.html</a> under the <a href="https://github.com/michaelsbradleyjr/node-clojurescript/tree/master/licenses">licenses directory</a> at the
root of this distribution. By using this software in any fashion,
you are agreeing to be bound by the terms of this license. You must
not remove this notice, or any other, from this software.</p>

<h3>credit</h3>

<p>This software is derived from and incorporates existing works:</p>

<p><a href="https://github.com/jashkenas/coffee-script">CoffeeScript</a>,&nbsp;
<a href="https://github.com/clojure/clojurescript">ClojureScript</a>,&nbsp;
<a href="https://github.com/cemerick/pomegranate">Pomegranate</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 